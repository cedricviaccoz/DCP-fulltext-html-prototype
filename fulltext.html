<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">

    <title>Download full text</title>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>

  </head>

  <body>

		<div class="no-content">
			This document currently holds no OCR text to be downloaded.
		</div>

		<div class="progress-bar">
			progress bar TODO
		</div>

    <div id="fulltext-zone">

    </div>

		<script type="text/javascript">
			const drs_id = 2678271; // TODO: feed this variable from url
			const hasocr = false; // TODO: call hasocr endpoint for result

			var full_text_list = []
			const full_text = document.querySelector('.full-text');
			var text = '';

			if (hasocr) {
				document.getElementsByClassName('no-content')[0].style.display = "none";
        $(document).ready(function() {
          $.ajax({
            url: "http://fds.lib.harvard.edu/fds/deliver/" + drs_id
          }).then(function(xml_DOM) {
            process_xml(xml_DOM)
          }).then(function() {
            add_text();
          });
        });
			} else {
				document.getElementsByClassName('no-content')[0].style.display = "block";
			};


      function process_xml(xml_DOM) {
        console.log(typeof xml_DOM,"...type of request.responseXML");
        console.log(xml_DOM.documentElement.nodeName == "parsererror" ? "error while parsing" : xml_DOM.documentElement.nodeName,"...name of root element of request.responseXML");
        var fileSec = xml_DOM.getElementsByTagName("fileSec")[0]; // fileSec is an Element
        var fileGrps = fileSec.children; // fileGrps is an HTML Collection

        for (let g = 0; g < fileGrps.length; g++) {
          fileGrp = fileGrps[g];
          if (fileGrp.getAttribute("USE") == "text-plain") {
            console.log("Plain text found on iteration ",g);
            let txt_nodes = fileGrp.children; // txt_nodes is an HTML Collection
            console.log(txt_nodes.length," ...length of txt_nodes");
            for (let i = 0; i < txt_nodes.length; i++) { // txt_nodes.length , or 3 for testing
              let textZone = document.getElementById('fulltext-zone');
          		let newDiv = document.createElement('div');
          		newDiv.setAttribute("id", i+1);
              newDiv.setAttribute("drs_id", txt_nodes[i].firstElementChild.getAttribute("xlink:href"))
              textZone.appendChild(newDiv);
            }
          }
        }
      }

      function add_text() {
        var page_divs = document.getElementById("fulltext-zone").children;
        for (let i = 0; i < page_divs.length; i++) { // replace 3 with page_divs.length
          // console.log(page_divs[i].getAttribute("drs_id"))
          $.ajax({
            url: "http://fds.lib.harvard.edu/fds/deliver/" + page_divs[i].getAttribute("drs_id")
          }).then(function(data) {
            console.log(data)
            console.log(typeof page_divs)
            page_divs[i].innerText = data;
          });
        }
      }

		</script>

	</body>

</html>

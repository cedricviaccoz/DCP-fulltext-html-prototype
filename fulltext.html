<div id="no-content"> This document currently holds no OCR text to be downloaded. 
</div>

<div id="progress">
  <div id="bar"></div>
  <div id="loading-text">Retrieving item metadata, please wait...</div>
</div>

<div id="fulltext-zone">

</div>

<script type="text/javascript">
	const drs_id = 2585728;
	const hasocr = true;
	const pageIncrementValue = 5;

	//const drs_id = <%document[:drs_id]%>

	if(hasocr){
		// async and await and sleep are all used to simulate an API request taking time to get resolved.
		async function update(){
			document.getElementById('no-content').style.display = "none";
			let pageNumber = retrieveNumberOfPages(drs_id);
			let pageAccumulator = ''
			let pageAccNumber = 0
			for(let i = 0; i<pageNumber; ++i){
				//sleeping to simulate API call taking time to get resolved.
				await sleep(100);
				let pageOCR = (String(drs_id)+" : "+String(i)+";");
				pageAccumulator += pageOCR;
				pageAccNumber++;
				if(pageAccNumber>=pageIncrementValue){
					updateTextZone(pageAccumulator, i);
					updateBar(i+1, pageNumber);
					pageAccumulator = '';
					pageAccNumber = 0;
				} else if(i == pageNumber - 1){
					/*as we update the text zone only by increment of 'pageIncrementValue', 
					  we need to treat the case the number of pages is not a multilpe of 
					  the pageIncrementValue and display the last elements left in the
					  string accumulator*/
					updateTextZone(pageAccumulator, i);
					updateBar(i+1, pageNumber);
				}
			}
			document.getElementById('progress').style.display = "none";	
		}
		update();
	}else{
		document.getElementById('no-content').style.display = "block";
		document.getElementById('progress').style.display = "none";
	}

	function updateTextZone(textToAppend, currIndex){
		let textZone = document.getElementById('fulltext-zone');
		let newDiv = document.createElement('div');
		newDiv.setAttribute("id", ("fulltext-part-"+String(currIndex-pageIncrementValue)+"-to-"+String(currIndex)));
		newDiv.innerText += textToAppend;
		textZone.appendChild(newDiv);
	}


	function retrieveNumberOfPages(drs_id){
		//TODO: insert the actual API call to retrieve the page number from the iiif manifest.
		return 120;
	}


	function updateBar(currentPage, totalPage) {
	  let bar = document.getElementById("bar"); 
	  let width = (currentPage/totalPage) * 100;
      bar.style.width = width + '%'; 
      let loadText = document.getElementById("loading-text"); 
      loadText.innerText = "Loading full text ("+ String(currentPage)+" of "+String(totalPage)+" pages)"
	}


	//TODO: remove
	function sleep(ms) {
	  return new Promise(resolve => setTimeout(resolve, ms));
	}


</script>

<style type="text/css">
#progress {
	width: 100%;
	height: 40px;
	background-color: white;
	position: relative;
	border: solid;
}

#bar {
	width: 1%;
	height: 40px;
	background-color: silver;
}

#loading-text {
	position: absolute;
	top: 10px;
	height: 20px;
	font-family: "Trueno", Helvetica, Roboto, Arial, sans-serif;
	text-align: center;
	width: 100%;
	z-index: 10;
}

</style>
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">

    <title>Download full text</title>

  </head>

  <body>

		<div class="no-content">
			This document currently holds no OCR text to be downloaded.
		</div>

		<div class="progress-bar">
			progress bar TODO
		</div>

		<div class="full-text">
			full text TODO
		</div>

		<script type="text/javascript">
			const drs_id = 6622876;
			const eg_page_id = 6098394; // for testing
			const hasocr = false;

			var full_text_dict = {}
			const full_text = document.querySelector('.full-text');

			if (hasocr) {
				document.getElementsByClassName('no-content')[0].style.display = "none";
			} else {
				document.getElementsByClassName('no-content')[0].style.display = "block";
			};
			//const drs_id = <%document[:drs_id]%>

			// *********
			// const ordered = {};
			// Object.keys(unordered).sort().forEach(function(key) {
			//   ordered[key] = unordered[key];
			// });
			// *************

			function fds_handler() {
			  if(this.status == 200) {
			    // success!
					full_text_dict[this.requestURL] = this.response
			  } else {
			    // something went wrong
			    console.log("\nThe server could not load the page text.");
			  }
			}

			function extract_page_ids_from_xml(xml_DOM) {   //xml_DOM is a Document

				console.log(typeof xml_DOM,"...type of request.responseXML");
				console.log(xml_DOM.documentElement.nodeName == "parsererror" ? "error while parsing" : xml_DOM.documentElement.nodeName,"...name of root element of request.responseXML");
				var fileSec = xml_DOM.getElementsByTagName("fileSec")[0]; // fileSec is an Element
				var fileGrps = fileSec.children; // fileGrps is an HTML Collection

				for (let g = 0; g < fileGrps.length; g++) {
					fileGrp = fileGrps[g];
					if (fileGrp.getAttribute("USE") == "text-plain") {
						console.log("Plain text found on iteration ",g)
						var txt_nodes = fileGrp.children // txt_nodes is an HTML Collection
						console.log(txt_nodes," ...txt_nodes")
						for (let i = 0; i < 3; i++) { // !!! REPLACE 3 WITH txt_nodes.length
							var txt_node = txt_nodes[i];
							var page_id = txt_node.firstElementChild.getAttribute("xlink:href");
							console.log(page_id," ...page_id")
							var request_txt = new XMLHttpRequest;
							request_txt.onload = fds_handler;
							request_txt.open("GET", "http://fds.lib.harvard.edu/fds/deliver/" + page_id + "?callback=" + (i+1));
							request_txt.send();
						}
					}
				}

				console.log(fileGrps.length," ... length of fileGrps");

				// for each in txt_nodes:


				// console.log(txt_nodes.length,"...length of txt_nodes");



				full_text.textContent = fileGrps;


			}

			function xml_handler() {
			  if(this.status == 200 &&
			    this.responseXML != null &&
			    this.responseXML.documentElement.nodeName) {
			    // success!
			    extract_page_ids_from_xml(this.responseXML);
			  } else {
			    // something went wrong
			    document.write("\nThe server could not load the page IDs. Please wait a moment and refresh the page.");
			  }
			}

			var request_xml = new XMLHttpRequest();
			request_xml.onload = xml_handler;
			request_xml.open("GET", "http://fds.lib.harvard.edu/fds/deliver/" + drs_id);
			request_xml.send();

		</script>

	</body>

</html>
